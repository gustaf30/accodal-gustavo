{
  "workflows": [
    {
      "name": "login",
      "trigger": "button:click",
      "description": "Handle user login with email/password",
      "steps": [
        {
          "action": "setVariable",
          "params": {
            "name": "isLoading",
            "value": true
          }
        },
        {
          "action": "supabase.auth.signInWithPassword",
          "params": {
            "email": "{{forms.loginForm.email}}",
            "password": "{{forms.loginForm.password}}"
          },
          "output": "authResult"
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{authResult.error}}"
          },
          "then": [
            {
              "action": "toast",
              "params": {
                "type": "error",
                "message": "{{authResult.error.message}}"
              }
            }
          ],
          "else": [
            {
              "action": "navigate",
              "params": {
                "path": "/dashboard"
              }
            }
          ]
        },
        {
          "action": "setVariable",
          "params": {
            "name": "isLoading",
            "value": false
          }
        }
      ]
    },
    {
      "name": "register",
      "trigger": "button:click",
      "description": "Handle new user registration",
      "steps": [
        {
          "action": "condition",
          "params": {
            "condition": "{{forms.registerForm.password !== forms.registerForm.confirmPassword}}"
          },
          "then": [
            {
              "action": "toast",
              "params": {
                "type": "error",
                "message": "Passwords do not match"
              }
            },
            {
              "action": "return"
            }
          ]
        },
        {
          "action": "setVariable",
          "params": {
            "name": "isLoading",
            "value": true
          }
        },
        {
          "action": "supabase.auth.signUp",
          "params": {
            "email": "{{forms.registerForm.email}}",
            "password": "{{forms.registerForm.password}}",
            "options": {
              "data": {
                "full_name": "{{forms.registerForm.fullName}}"
              }
            }
          },
          "output": "authResult"
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{authResult.error}}"
          },
          "then": [
            {
              "action": "toast",
              "params": {
                "type": "error",
                "message": "{{authResult.error.message}}"
              }
            }
          ],
          "else": [
            {
              "action": "toast",
              "params": {
                "type": "success",
                "message": "Account created! Please check your email to verify."
              }
            },
            {
              "action": "navigate",
              "params": {
                "path": "/login"
              }
            }
          ]
        },
        {
          "action": "setVariable",
          "params": {
            "name": "isLoading",
            "value": false
          }
        }
      ]
    },
    {
      "name": "logout",
      "trigger": "button:click",
      "description": "Handle user logout",
      "steps": [
        {
          "action": "supabase.auth.signOut"
        },
        {
          "action": "navigate",
          "params": {
            "path": "/login"
          }
        }
      ]
    },
    {
      "name": "handleFileDrop",
      "trigger": "dropzone:drop",
      "description": "Handle file drop on upload zone",
      "steps": [
        {
          "action": "setVariable",
          "params": {
            "name": "uploadFiles",
            "value": "{{[...variables.uploadFiles, ...event.files]}}"
          }
        }
      ]
    },
    {
      "name": "removeFile",
      "trigger": "button:click",
      "description": "Remove file from upload list",
      "params": ["index"],
      "steps": [
        {
          "action": "setVariable",
          "params": {
            "name": "uploadFiles",
            "value": "{{variables.uploadFiles.filter((_, i) => i !== params.index)}}"
          }
        }
      ]
    },
    {
      "name": "uploadFiles",
      "trigger": "button:click",
      "description": "Upload selected files to API",
      "steps": [
        {
          "action": "setVariable",
          "params": {
            "name": "isUploading",
            "value": true
          }
        },
        {
          "action": "setVariable",
          "params": {
            "name": "uploadProgress",
            "value": 0
          }
        },
        {
          "action": "custom",
          "code": "async function uploadFiles() {\n  const files = variables.uploadFiles;\n  const items = [];\n  \n  for (let i = 0; i < files.length; i++) {\n    const file = files[i];\n    const base64 = await fileToBase64(file);\n    const isAudio = file.type.startsWith('audio/');\n    \n    items.push({\n      type: isAudio ? 'audio' : 'document',\n      data: {\n        filename: file.name,\n        mime_type: file.type,\n        base64_content: base64,\n        user_id: currentUser.id\n      }\n    });\n    \n    setVariable('uploadProgress', Math.round(((i + 1) / files.length) * 50));\n  }\n  \n  return items;\n}\n\nasync function fileToBase64(file) {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result.split(',')[1]);\n    reader.onerror = reject;\n    reader.readAsDataURL(file);\n  });\n}\n\nreturn uploadFiles();",
          "output": "uploadItems"
        },
        {
          "action": "http.post",
          "params": {
            "url": "{{env.API_URL}}/api/v1/batch/process",
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "Bearer {{currentUser.access_token}}"
            },
            "body": {
              "items": "{{uploadItems}}",
              "user_id": "{{currentUser.id}}"
            }
          },
          "output": "batchResult"
        },
        {
          "action": "setVariable",
          "params": {
            "name": "currentJobId",
            "value": "{{batchResult.data.job_id}}"
          }
        },
        {
          "action": "workflow",
          "params": {
            "name": "pollJobStatus"
          }
        }
      ]
    },
    {
      "name": "pollJobStatus",
      "trigger": "workflow",
      "description": "Poll batch job status until complete",
      "steps": [
        {
          "action": "http.get",
          "params": {
            "url": "{{env.API_URL}}/api/v1/batch/jobs/{{variables.currentJobId}}",
            "headers": {
              "Authorization": "Bearer {{currentUser.access_token}}"
            }
          },
          "output": "jobStatus"
        },
        {
          "action": "setVariable",
          "params": {
            "name": "uploadProgress",
            "value": "{{50 + (jobStatus.data.progress || 0) * 0.5}}"
          }
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{jobStatus.data.status === 'completed' || jobStatus.data.status === 'failed'}}"
          },
          "then": [
            {
              "action": "setVariable",
              "params": {
                "name": "isUploading",
                "value": false
              }
            },
            {
              "action": "setVariable",
              "params": {
                "name": "uploadProgress",
                "value": 100
              }
            },
            {
              "action": "setVariable",
              "params": {
                "name": "uploadResult",
                "value": {
                  "success": "{{jobStatus.data.status === 'completed'}}",
                  "message": "{{jobStatus.data.status === 'completed' ? 'All files processed successfully!' : 'Some files failed to process. Check the documents page for details.'}}"
                }
              }
            },
            {
              "action": "setVariable",
              "params": {
                "name": "uploadFiles",
                "value": []
              }
            },
            {
              "action": "collection.refresh",
              "params": {
                "name": "UserDocuments"
              }
            }
          ],
          "else": [
            {
              "action": "delay",
              "params": {
                "ms": 2000
              }
            },
            {
              "action": "workflow",
              "params": {
                "name": "pollJobStatus"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "search",
      "trigger": "input:change",
      "description": "Perform RAG search",
      "steps": [
        {
          "action": "condition",
          "params": {
            "condition": "{{!variables.searchQuery || variables.searchQuery.length < 2}}"
          },
          "then": [
            {
              "action": "return"
            }
          ]
        },
        {
          "action": "setVariable",
          "params": {
            "name": "isSearching",
            "value": true
          }
        },
        {
          "action": "collection.fetch",
          "params": {
            "name": "SearchResults"
          }
        },
        {
          "action": "setVariable",
          "params": {
            "name": "isSearching",
            "value": false
          }
        }
      ]
    },
    {
      "name": "reprocessDocument",
      "trigger": "button:click",
      "description": "Reprocess a document",
      "params": ["documentId"],
      "steps": [
        {
          "action": "confirm",
          "params": {
            "title": "Reprocess Document",
            "message": "Are you sure you want to reprocess this document?"
          },
          "output": "confirmed"
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{!confirmed}}"
          },
          "then": [
            {
              "action": "return"
            }
          ]
        },
        {
          "action": "http.post",
          "params": {
            "url": "{{env.API_URL}}/api/v1/documents/{{params.documentId}}/reprocess",
            "headers": {
              "Authorization": "Bearer {{currentUser.access_token}}"
            }
          },
          "output": "result"
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{result.success}}"
          },
          "then": [
            {
              "action": "toast",
              "params": {
                "type": "success",
                "message": "Document queued for reprocessing"
              }
            },
            {
              "action": "collection.refresh",
              "params": {
                "name": "UserDocuments"
              }
            }
          ],
          "else": [
            {
              "action": "toast",
              "params": {
                "type": "error",
                "message": "Failed to reprocess document"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "deleteDocument",
      "trigger": "button:click",
      "description": "Delete a document",
      "params": ["documentId"],
      "steps": [
        {
          "action": "confirm",
          "params": {
            "title": "Delete Document",
            "message": "Are you sure you want to delete this document? This action cannot be undone.",
            "confirmText": "Delete",
            "confirmVariant": "danger"
          },
          "output": "confirmed"
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{!confirmed}}"
          },
          "then": [
            {
              "action": "return"
            }
          ]
        },
        {
          "action": "http.delete",
          "params": {
            "url": "{{env.API_URL}}/api/v1/documents/{{params.documentId}}",
            "headers": {
              "Authorization": "Bearer {{currentUser.access_token}}"
            }
          },
          "output": "result"
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{result.success}}"
          },
          "then": [
            {
              "action": "toast",
              "params": {
                "type": "success",
                "message": "Document deleted successfully"
              }
            },
            {
              "action": "collection.refresh",
              "params": {
                "name": "UserDocuments"
              }
            },
            {
              "action": "navigate",
              "params": {
                "path": "/documents"
              }
            }
          ],
          "else": [
            {
              "action": "toast",
              "params": {
                "type": "error",
                "message": "Failed to delete document"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "downloadDocument",
      "trigger": "button:click",
      "description": "Download document from storage",
      "steps": [
        {
          "action": "supabase.storage.download",
          "params": {
            "bucket": "documents",
            "path": "{{collections.DocumentDetails.storage_path}}"
          },
          "output": "fileData"
        },
        {
          "action": "download",
          "params": {
            "data": "{{fileData}}",
            "filename": "{{collections.DocumentDetails.filename}}"
          }
        }
      ]
    },
    {
      "name": "filterDocuments",
      "trigger": "select:change",
      "description": "Filter documents by type or status",
      "steps": [
        {
          "action": "collection.setFilter",
          "params": {
            "name": "UserDocuments",
            "filters": [
              {
                "field": "type",
                "operator": "eq",
                "value": "{{forms.typeFilter || null}}"
              },
              {
                "field": "status",
                "operator": "eq",
                "value": "{{forms.statusFilter || null}}"
              }
            ]
          }
        },
        {
          "action": "collection.refresh",
          "params": {
            "name": "UserDocuments"
          }
        }
      ]
    },
    {
      "name": "toggleNotifications",
      "trigger": "button:click",
      "description": "Toggle notifications panel",
      "steps": [
        {
          "action": "setVariable",
          "params": {
            "name": "showNotifications",
            "value": "{{!variables.showNotifications}}"
          }
        }
      ]
    },
    {
      "name": "markNotificationRead",
      "trigger": "button:click",
      "description": "Mark notification as read",
      "params": ["notificationId"],
      "steps": [
        {
          "action": "supabase.update",
          "params": {
            "table": "error_notifications",
            "filter": "id=eq.{{params.notificationId}}",
            "data": {
              "sent_at": "{{new Date().toISOString()}}"
            }
          }
        },
        {
          "action": "collection.refresh",
          "params": {
            "name": "Notifications"
          }
        },
        {
          "action": "collection.refresh",
          "params": {
            "name": "UnreadNotificationsCount"
          }
        }
      ]
    },
    {
      "name": "updateProfile",
      "trigger": "button:click",
      "description": "Update user profile",
      "steps": [
        {
          "action": "supabase.auth.updateUser",
          "params": {
            "data": {
              "full_name": "{{forms.profileForm.fullName}}"
            }
          },
          "output": "result"
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{result.error}}"
          },
          "then": [
            {
              "action": "toast",
              "params": {
                "type": "error",
                "message": "{{result.error.message}}"
              }
            }
          ],
          "else": [
            {
              "action": "toast",
              "params": {
                "type": "success",
                "message": "Profile updated successfully"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "changePassword",
      "trigger": "button:click",
      "description": "Change user password",
      "steps": [
        {
          "action": "condition",
          "params": {
            "condition": "{{forms.passwordForm.newPassword !== forms.passwordForm.confirmNewPassword}}"
          },
          "then": [
            {
              "action": "toast",
              "params": {
                "type": "error",
                "message": "New passwords do not match"
              }
            },
            {
              "action": "return"
            }
          ]
        },
        {
          "action": "supabase.auth.updateUser",
          "params": {
            "password": "{{forms.passwordForm.newPassword}}"
          },
          "output": "result"
        },
        {
          "action": "condition",
          "params": {
            "condition": "{{result.error}}"
          },
          "then": [
            {
              "action": "toast",
              "params": {
                "type": "error",
                "message": "{{result.error.message}}"
              }
            }
          ],
          "else": [
            {
              "action": "toast",
              "params": {
                "type": "success",
                "message": "Password changed successfully"
              }
            },
            {
              "action": "form.reset",
              "params": {
                "name": "passwordForm"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "viewTranscription",
      "trigger": "button:click",
      "description": "View audio transcription in modal",
      "params": ["transcriptionId"],
      "steps": [
        {
          "action": "supabase.select",
          "params": {
            "table": "audio_transcriptions",
            "filter": "id=eq.{{params.transcriptionId}}",
            "single": true
          },
          "output": "transcription"
        },
        {
          "action": "modal.open",
          "params": {
            "title": "{{transcription.filename}}",
            "content": {
              "type": "transcription-viewer",
              "data": "{{transcription}}"
            }
          }
        }
      ]
    },
    {
      "name": "viewExtraction",
      "trigger": "button:click",
      "description": "View text extraction in modal",
      "params": ["extractionId"],
      "steps": [
        {
          "action": "supabase.select",
          "params": {
            "table": "text_extractions",
            "filter": "id=eq.{{params.extractionId}}",
            "single": true
          },
          "output": "extraction"
        },
        {
          "action": "modal.open",
          "params": {
            "title": "{{extraction.subject || extraction.source}}",
            "content": {
              "type": "extraction-viewer",
              "data": "{{extraction}}"
            }
          }
        }
      ]
    }
  ],
  "realtime": {
    "subscriptions": [
      {
        "name": "documents-changes",
        "table": "documents",
        "event": "*",
        "filter": "user_id=eq.{{currentUser.id}}",
        "onEvent": "collection.refresh:UserDocuments"
      },
      {
        "name": "notifications-insert",
        "table": "error_notifications",
        "event": "INSERT",
        "filter": "user_id=eq.{{currentUser.id}}",
        "onEvent": [
          "collection.refresh:Notifications",
          "collection.refresh:UnreadNotificationsCount",
          "toast:info:New notification received"
        ]
      }
    ]
  }
}
