# System Architecture & Workflow Diagrams

## 1. High-Level System Architecture

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                 CLIENT LAYER                                      │
│                                                                                   │
│     ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                    │
│     │   WeWeb     │      │   Mobile    │      │   Direct    │                    │
│     │   Portal    │      │    App      │      │    API      │                    │
│     └──────┬──────┘      └──────┬──────┘      └──────┬──────┘                    │
│            │                    │                    │                            │
└────────────┼────────────────────┼────────────────────┼────────────────────────────┘
             │                    │                    │
             └────────────────────┼────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              API GATEWAY (Vercel)                                 │
│                                                                                   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐                  │
│  │    Auth    │  │   Rate     │  │   Input    │  │   Route    │                  │
│  │ Middleware │─▶│  Limiter   │─▶│ Validation │─▶│  Handler   │                  │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘                  │
│                                                                                   │
└──────────────────────────────────────────┬───────────────────────────────────────┘
                                           │
                      ┌────────────────────┴────────────────────┐
                      │                                         │
                      ▼                                         ▼
┌─────────────────────────────────┐       ┌─────────────────────────────────┐
│         REDIS QUEUE             │       │      N8N ORCHESTRATOR           │
│                                 │       │                                 │
│  Priority Levels:               │       │  ┌─────────────────────────┐   │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ │       │  │   Master Orchestrator   │   │
│  │P0 │ │P1 │ │P2 │ │P3 │ │P4 │ │◀─────▶│  │   POST /orchestrate     │   │
│  └───┘ └───┘ └───┘ └───┘ └───┘ │       │  └───────────┬─────────────┘   │
│   ▲                             │       │              │                 │
│   │ Rate Limiting               │       │              ▼                 │
│   │ Sliding Window              │       │  ┌───────────────────────┐    │
│  50 req/min                     │       │  │    Task Router        │    │
└─────────────────────────────────┘       │  └───────────┬───────────┘    │
                                          │              │                 │
                                          └──────────────┼─────────────────┘
                                                         │
                         ┌───────────────────────────────┼───────────────────────────────┐
                         │                               │                               │
                         ▼                               ▼                               ▼
          ┌──────────────────────────┐   ┌──────────────────────────┐   ┌──────────────────────────┐
          │    DOCUMENT WORKER       │   │     AUDIO WORKER         │   │      TEXT WORKER         │
          │                          │   │                          │   │                          │
          │  1. Download file        │   │  1. Download audio       │   │  1. Parse input          │
          │  2. OCR (GPT-4 Vision)   │   │  2. Transcribe (Whisper) │   │  2. NLP extraction       │
          │  3. Classify type        │   │  3. Extract entities     │   │  3. Validate data        │
          │  4. Extract data         │   │  4. Store results        │   │  4. Store results        │
          │  5. Generate embedding   │   │                          │   │                          │
          │  6. Store results        │   │                          │   │                          │
          └────────────┬─────────────┘   └────────────┬─────────────┘   └────────────┬─────────────┘
                       │                              │                              │
                       └──────────────────────────────┼──────────────────────────────┘
                                                      │
                                                      ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              SUPABASE BACKEND                                     │
│                                                                                   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │
│  │ PostgreSQL │  │  pgvector  │  │  Storage   │  │    Auth    │  │  Realtime  │ │
│  │            │  │            │  │            │  │            │  │            │ │
│  │ documents  │  │ embeddings │  │   files    │  │   users    │  │  webhooks  │ │
│  │ audio      │  │ 1536 dims  │  │   bucket   │  │  sessions  │  │   events   │ │
│  │ text       │  │            │  │            │  │            │  │            │ │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │
│                                                                                   │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Master Orchestrator Workflow

```
                              ┌─────────────────────────────┐
                              │      WEBHOOK TRIGGER        │
                              │    POST /webhook/orchestrate │
                              └─────────────┬───────────────┘
                                            │
                                            ▼
                              ┌─────────────────────────────┐
                              │      VALIDATE REQUEST       │
                              │                             │
                              │  Required fields:           │
                              │  • task_type                │
                              │  • payload.filename         │
                              │  • payload.file_url         │
                              └─────────────┬───────────────┘
                                            │
                              ┌─────────────┴───────────────┐
                              │                             │
                           VALID                        INVALID
                              │                             │
                              ▼                             ▼
                ┌─────────────────────────┐    ┌─────────────────────────┐
                │    ROUTE BY TASK TYPE   │    │     RETURN ERROR        │
                └─────────────┬───────────┘    │   400 Bad Request       │
                              │                └─────────────────────────┘
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │  task_type  │     │  task_type  │     │  task_type  │
   │ "document"  │     │   "audio"   │     │   "text"    │
   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
          │                   │                   │
          ▼                   ▼                   ▼
   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │  EXECUTE    │     │  EXECUTE    │     │  EXECUTE    │
   │  Document   │     │   Audio     │     │    Text     │
   │   Worker    │     │   Worker    │     │   Worker    │
   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              │
                              ▼
                ┌─────────────────────────────┐
                │      RETURN RESPONSE        │
                │                             │
                │  {                          │
                │    "success": true,         │
                │    "document_id": "uuid",   │
                │    "type": "Invoice",       │
                │    "status": "completed"    │
                │  }                          │
                └─────────────────────────────┘
```

---

## 3. Document Worker - Detailed Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           DOCUMENT WORKER WORKFLOW                               │
└─────────────────────────────────────────────────────────────────────────────────┘

     START
       │
       ▼
┌─────────────────┐
│ Receive Payload │
│                 │
│ • filename      │
│ • file_url      │
│ • mime_type     │
│ • user_id       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌─────────────────┐
│  Download File  │─────▶│  Validate File  │
│  from Storage   │      │  • Size < 50MB  │
└─────────────────┘      │  • Valid type   │
                         └────────┬────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                 VALID                       INVALID
                    │                           │
                    ▼                           ▼
         ┌─────────────────┐         ┌─────────────────┐
         │   PROCESS FILE  │         │  RETURN ERROR   │
         └────────┬────────┘         └─────────────────┘
                  │
    ┌─────────────┴─────────────┐
    │                           │
  IMAGE                        PDF
    │                           │
    ▼                           ▼
┌─────────────────┐    ┌─────────────────┐
│  GPT-4 Vision   │    │   PDF Parser    │
│     OCR         │    │   + OCR         │
└────────┬────────┘    └────────┬────────┘
         │                      │
         └──────────┬───────────┘
                    │
                    ▼
         ┌─────────────────┐
         │  EXTRACT TEXT   │
         │                 │
         │  raw_text =     │
         │  "INVOICE..."   │
         └────────┬────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ CLASSIFY TYPE   │
         │                 │
         │ AI determines:  │
         │ • W-2           │
         │ • 1099-MISC     │
         │ • 1099-NEC      │
         │ • Invoice       │
         │ • Receipt       │
         │ • Other         │
         └────────┬────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ EXTRACT DATA    │
         │                 │
         │ Based on type:  │
         │ Invoice →       │
         │  • company      │
         │  • items[]      │
         │  • total        │
         │ W-2 →           │
         │  • employer     │
         │  • wages        │
         │  • tax_withheld │
         └────────┬────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ GENERATE        │
         │ EMBEDDING       │
         │                 │
         │ OpenAI          │
         │ text-embedding  │
         │ -3-small        │
         │ (1536 dims)     │
         └────────┬────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ SAVE TO DB      │
         │                 │
         │ • documents     │
         │ • embeddings    │
         └────────┬────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ RETURN RESULT   │
         │                 │
         │ document_id     │
         │ type            │
         │ extracted_data  │
         │ confidence      │
         └─────────────────┘
```

---

## 4. Error Handling & Retry Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ERROR HANDLING WORKFLOW                                │
└─────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │  TASK FAILURE   │
                    │                 │
                    │ • API timeout   │
                    │ • Invalid file  │
                    │ • OCR error     │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  ERROR HANDLER  │
                    │    WORKFLOW     │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ CHECK RETRY     │
                    │ COUNT           │
                    └────────┬────────┘
                             │
               ┌─────────────┴─────────────┐
               │                           │
        retry_count < 3             retry_count >= 3
               │                           │
               ▼                           ▼
    ┌─────────────────┐         ┌─────────────────┐
    │   CALCULATE     │         │  DEAD LETTER    │
    │   BACKOFF       │         │     QUEUE       │
    │                 │         │                 │
    │ Retry 1: 2s     │         │ Save failed     │
    │ Retry 2: 4s     │         │ task for        │
    │ Retry 3: 8s     │         │ manual review   │
    └────────┬────────┘         └────────┬────────┘
             │                           │
             ▼                           ▼
    ┌─────────────────┐         ┌─────────────────┐
    │     WAIT        │         │  LOG ERROR      │
    │   (backoff)     │         │                 │
    └────────┬────────┘         │ error_id        │
             │                  │ task_type       │
             ▼                  │ payload         │
    ┌─────────────────┐         │ error_message   │
    │  RETRY TASK     │         │ retry_count     │
    │                 │         └────────┬────────┘
    │ increment       │                  │
    │ retry_count     │                  ▼
    └────────┬────────┘         ┌─────────────────┐
             │                  │  SEND ALERT     │
             │                  │                 │
             │                  │ • Slack         │
             │                  │ • Email         │
             │                  └─────────────────┘
             │
             ▼
    ┌─────────────────┐
    │  BACK TO        │
    │  ORCHESTRATOR   │
    └─────────────────┘
```

---

## 5. Batch Processing Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           BATCH PROCESSING                                       │
└─────────────────────────────────────────────────────────────────────────────────┘


INPUT: 50 Documents
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              SPLIT INTO BATCHES                                  │
│                                                                                  │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐        │
│  │ D1 │ │ D2 │ │ D3 │ │ D4 │ │ D5 │ │ D6 │ │ D7 │ │ D8 │ │ D9 │ │D10│  ...   │
│  └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘        │
│                                                                                  │
│                           Split into 5 batches of 10                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           PARALLEL PROCESSING                                    │
│                                                                                  │
│    Batch 1          Batch 2          Batch 3          Batch 4          Batch 5  │
│   ┌───────┐        ┌───────┐        ┌───────┐        ┌───────┐        ┌───────┐ │
│   │Worker │        │Worker │        │Worker │        │Worker │        │Worker │ │
│   │  #1   │        │  #2   │        │  #3   │        │  #4   │        │  #5   │ │
│   └───┬───┘        └───┬───┘        └───┬───┘        └───┬───┘        └───┬───┘ │
│       │                │                │                │                │     │
│       ▼                ▼                ▼                ▼                ▼     │
│   Processing       Processing       Processing       Processing       Processing│
│   D1-D10           D11-D20          D21-D30          D31-D40          D41-D50  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           AGGREGATE RESULTS                                      │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  Merge all results                                                      │   │
│   │  • Combine document records                                             │   │
│   │  • Resolve any conflicts (prefer higher confidence)                     │   │
│   │  • Cross-validate extracted data                                        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           FINAL OUTPUT                                           │
│                                                                                  │
│   {                                                                              │
│     "job_id": "batch-uuid",                                                      │
│     "total_items": 50,                                                           │
│     "processed": 48,                                                             │
│     "failed": 2,                                                                 │
│     "results": [...]                                                             │
│   }                                                                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Priority Queue System

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           PRIORITY QUEUE (Redis)                                 │
└─────────────────────────────────────────────────────────────────────────────────┘


    INCOMING TASKS                              QUEUE (Sorted Set)
    ══════════════                              ══════════════════

                                         Score = timestamp + (priority × 60000)

    ┌─────────────┐                      ┌─────────────────────────────────────┐
    │ P0: CRITICAL│ ─────────────────▶   │  Position 1: P0 task (score: low)   │
    │ Immediate   │                      ├─────────────────────────────────────┤
    └─────────────┘                      │  Position 2: P0 task               │
                                         ├─────────────────────────────────────┤
    ┌─────────────┐                      │  Position 3: P1 task               │
    │ P1: HIGH    │ ─────────────────▶   ├─────────────────────────────────────┤
    │ < 1 minute  │                      │  Position 4: P1 task               │
    └─────────────┘                      ├─────────────────────────────────────┤
                                         │  Position 5: P2 task               │
    ┌─────────────┐                      ├─────────────────────────────────────┤
    │ P2: NORMAL  │ ─────────────────▶   │  Position 6: P2 task               │
    │ < 5 minutes │                      ├─────────────────────────────────────┤
    └─────────────┘                      │  ...                                │
                                         ├─────────────────────────────────────┤
    ┌─────────────┐                      │  Position N: P4 task (score: high) │
    │ P3: LOW     │ ─────────────────▶   └─────────────────────────────────────┘
    │ < 15 minutes│
    └─────────────┘                                      │
                                                         │
    ┌─────────────┐                                      ▼
    │ P4: BACKGRND│ ─────────────────▶
    │ Best effort │                              ┌───────────────┐
    └─────────────┘                              │    WORKERS    │
                                                 │               │
                                                 │  Pop lowest   │
                                                 │  score first  │
                                                 │  (ZPOPMIN)    │
                                                 └───────────────┘
```

---

## 7. RAG Search Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           SEMANTIC SEARCH (RAG)                                  │
└─────────────────────────────────────────────────────────────────────────────────┘


    USER QUERY: "invoices with total over $100"
                            │
                            ▼
               ┌─────────────────────────┐
               │   GENERATE EMBEDDING    │
               │                         │
               │   OpenAI API            │
               │   text-embedding-3-small│
               │                         │
               │   Output: [0.02, -0.15, │
               │   0.33, ... ] (1536)    │
               └────────────┬────────────┘
                            │
                            ▼
               ┌─────────────────────────┐
               │   VECTOR SIMILARITY     │
               │        SEARCH           │
               │                         │
               │   Supabase pgvector     │
               │   cosine similarity     │
               │   threshold: 0.3        │
               └────────────┬────────────┘
                            │
                            ▼
               ┌─────────────────────────┐
               │   RANK BY SIMILARITY    │
               │                         │
               │   1. invoice.png  (46%) │
               │   2. 1099.png     (41%) │
               │   3. receipt.pdf  (38%) │
               │   4. contract.pdf (35%) │
               │   5. w2.png       (32%) │
               └────────────┬────────────┘
                            │
                            ▼
               ┌─────────────────────────┐
               │   JOIN WITH DOCUMENTS   │
               │                         │
               │   Add metadata:         │
               │   • filename            │
               │   • type                │
               │   • extracted_data      │
               │   • created_at          │
               └────────────┬────────────┘
                            │
                            ▼
               ┌─────────────────────────┐
               │   RETURN RESULTS        │
               │                         │
               │   {                     │
               │     "results": [...],   │
               │     "total": 5,         │
               │     "query": "...",     │
               │     "threshold": 0.3    │
               │   }                     │
               └─────────────────────────┘
```

---

## 8. Database Schema Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           DATABASE TABLES                                        │
└─────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────┐         ┌─────────────────────┐
│     documents       │         │  document_embeddings │
├─────────────────────┤         ├─────────────────────┤
│ id (PK)             │◀────────│ document_id (FK)    │
│ user_id (FK)        │         │ id (PK)             │
│ filename            │         │ content             │
│ file_url            │         │ embedding (vector)  │
│ type                │         │ chunk_index         │
│ raw_text            │         └─────────────────────┘
│ extracted_data      │
│ status              │         ┌─────────────────────┐
│ ocr_confidence      │         │ audio_transcriptions │
│ created_at          │         ├─────────────────────┤
└─────────────────────┘         │ id (PK)             │
                                │ user_id (FK)        │
┌─────────────────────┐         │ filename            │
│   batch_jobs        │         │ transcribed_text    │
├─────────────────────┤         │ extracted_entities  │
│ batch_id (PK)       │         │ status              │
│ total_items         │         └─────────────────────┘
│ completed_count     │
│ failed_count        │         ┌─────────────────────┐
│ status              │         │  dead_letter_queue  │
└─────────────────────┘         ├─────────────────────┤
                                │ id (PK)             │
┌─────────────────────┐         │ task_type           │
│   batch_items       │         │ payload             │
├─────────────────────┤         │ error_message       │
│ id (PK)             │         │ retry_count         │
│ batch_id (FK)       │         │ status              │
│ item_index          │         └─────────────────────┘
│ task_type           │
│ status              │         ┌─────────────────────┐
│ result              │         │ error_notifications │
└─────────────────────┘         ├─────────────────────┤
                                │ id (PK)             │
                                │ message             │
                                │ severity            │
                                │ acknowledged        │
                                └─────────────────────┘
```
